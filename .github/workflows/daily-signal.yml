name: Daily TQQQ Signal

on:
  schedule:
    # Run at 9:10 PM UTC (4:10 PM ET) every weekday after market close
    - cron: '10 21 * * 1-5'
  workflow_dispatch:  # Allow manual trigger

# Required permissions for pushing commits
permissions:
  contents: write  # Allow writing to repository
  issues: write    # Allow creating issues on signals

jobs:
  generate-signal:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}  # Use GitHub token for push access

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        uv sync

    - name: Create data directory
      run: |
        mkdir -p data

    - name: Test Yahoo Finance API
      run: |
        echo "Testing Yahoo Finance API accessibility..."
        uv run python tests/test_yfinance_api.py

    - name: Run TQQQ signal script
      id: signal
      continue-on-error: false  # Fail immediately if script fails
      run: |
        # Run the script and capture output
        uv run tqqq-sma > signal_output.txt 2>&1
        SCRIPT_EXIT_CODE=$?

        echo "Script exited with code: $SCRIPT_EXIT_CODE"

        # Display output for debugging
        echo "=== Script Output ==="
        cat signal_output.txt
        echo "=== End Output ==="

        # If script failed, exit workflow immediately (no summary, no parsing)
        if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
          echo "âŒ Script failed to fetch data or encountered an error"
          echo "   This could be due to:"
          echo "   - Market holiday (no trading data)"
          echo "   - Yahoo Finance API error"
          echo "   - Network issues"
          echo "   - Rate limiting"
          echo ""
          echo "Workflow will fail without updating summary or committing data."
          exit 1
        fi

        # Check if fresh data was fetched (not from cache)
        if grep -q "Using cached data" signal_output.txt; then
          echo "should_commit=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸  Using cached data - no commit needed"
        else
          echo "should_commit=true" >> $GITHUB_OUTPUT
          echo "âœ… Fresh data fetched - will commit updates"
        fi

        # Script succeeded - parse output for summary
        # Extract key information from output - ONLY THE VALUES
        SIGNAL=$(grep -E "(ALERT: BUY|ALERT: SELL|STATUS: Holding)" signal_output.txt | tail -1 || echo "No signal detected")
        DATE=$(grep "Date:" signal_output.txt | grep -v "Last Signal" | head -1 | awk '{print $2}' || echo "Unknown")
        QQQ_CLOSE=$(grep "QQQ Close:" signal_output.txt | head -1 | awk '{print $3}' || echo "Unknown")
        TQQQ_CLOSE=$(grep "TQQQ Close:" signal_output.txt | head -1 | awk '{print $3}' || echo "Unknown")
        SMA200=$(grep "SMA200:" signal_output.txt | grep -v "QQQ vs" | head -1 | awk '{print $2}' || echo "Unknown")
        QQQ_VS_SMA=$(grep "QQQ vs SMA200:" signal_output.txt | head -1 | awk '{print $4}' || echo "Unknown")
        BUY_THRESHOLD=$(grep "BUY Threshold" signal_output.txt | head -1 | awk '{print $4}' || echo "Unknown")
        SELL_THRESHOLD=$(grep "SELL Threshold" signal_output.txt | head -1 | awk '{print $4}' || echo "Unknown")
        POSITION=$(grep "Position:" signal_output.txt | head -1 | awk '{print $2}' || echo "Unknown")

        # Debug: show what we captured
        echo "=== Captured Data ==="
        echo "SIGNAL: [$SIGNAL]"
        echo "DATE: [$DATE]"
        echo "QQQ_CLOSE: [$QQQ_CLOSE]"
        echo "TQQQ_CLOSE: [$TQQQ_CLOSE]"
        echo "SMA200: [$SMA200]"
        echo "QQQ_VS_SMA: [$QQQ_VS_SMA]"
        echo "BUY_THRESHOLD: [$BUY_THRESHOLD]"
        echo "SELL_THRESHOLD: [$SELL_THRESHOLD]"
        echo "POSITION: [$POSITION]"
        echo "====================="

        # Show the actual matching lines for debugging
        echo "=== Matched Lines ==="
        echo "Date line: $(grep 'Date:' signal_output.txt | grep -v 'Last Signal' | head -1)"
        echo "QQQ Close line: $(grep 'QQQ Close:' signal_output.txt | head -1)"
        echo "TQQQ Close line: $(grep 'TQQQ Close:' signal_output.txt | head -1)"
        echo "SMA200 line: $(grep 'SMA200:' signal_output.txt | grep -v 'QQQ vs' | head -1)"
        echo "====================="

        # Verify extracted values are not empty
        if [ -z "$DATE" ] || [ "$DATE" = "Unknown" ]; then
          echo "âš ï¸  WARNING: Failed to extract date from output"
        fi
        if [ -z "$QQQ_CLOSE" ] || [ "$QQQ_CLOSE" = "Unknown" ]; then
          echo "âš ï¸  WARNING: Failed to extract QQQ close from output"
        fi

        # Save to GITHUB_OUTPUT (need to handle multiline carefully)
        {
          echo "signal=$SIGNAL"
          echo "date=$DATE"
          echo "qqq_close=$QQQ_CLOSE"
          echo "tqqq_close=$TQQQ_CLOSE"
          echo "sma200=$SMA200"
          echo "qqq_vs_sma=$QQQ_VS_SMA"
          echo "buy_threshold=$BUY_THRESHOLD"
          echo "sell_threshold=$SELL_THRESHOLD"
          echo "position=$POSITION"
        } >> $GITHUB_OUTPUT

        # Determine if this is a BUY or SELL alert (for notifications)
        if echo "$SIGNAL" | grep -q "ALERT: BUY"; then
          echo "alert_type=BUY" >> $GITHUB_OUTPUT
          echo "is_alert=true" >> $GITHUB_OUTPUT
        elif echo "$SIGNAL" | grep -q "ALERT: SELL"; then
          echo "alert_type=SELL" >> $GITHUB_OUTPUT
          echo "is_alert=true" >> $GITHUB_OUTPUT
        else
          echo "alert_type=HOLD" >> $GITHUB_OUTPUT
          echo "is_alert=false" >> $GITHUB_OUTPUT
        fi

        # Extract just the date for timestamp file
        TRADE_DATE=$(echo "$DATE" | awk '{print $2}')
        echo "trade_date=$TRADE_DATE" >> $GITHUB_OUTPUT

        exit 0

    - name: Generate Summary
      if: always()
      run: |
        # Use shell variables to avoid shell interpretation of $ in values
        DATE='${{ steps.signal.outputs.date }}'
        QQQ_CLOSE='${{ steps.signal.outputs.qqq_close }}'
        TQQQ_CLOSE='${{ steps.signal.outputs.tqqq_close }}'
        SMA200='${{ steps.signal.outputs.sma200 }}'
        QQQ_VS_SMA='${{ steps.signal.outputs.qqq_vs_sma }}'
        BUY_THRESHOLD='${{ steps.signal.outputs.buy_threshold }}'
        SELL_THRESHOLD='${{ steps.signal.outputs.sell_threshold }}'
        POSITION='${{ steps.signal.outputs.position }}'
        SIGNAL='${{ steps.signal.outputs.signal }}'
        ALERT_TYPE='${{ steps.signal.outputs.alert_type }}'

        echo "# ðŸ“Š TQQQ 200-Day SMA Daily Signal" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Market Data" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Date** | $DATE |" >> $GITHUB_STEP_SUMMARY
        echo "| **QQQ Close** | $QQQ_CLOSE |" >> $GITHUB_STEP_SUMMARY
        echo "| **TQQQ Close** | $TQQQ_CLOSE |" >> $GITHUB_STEP_SUMMARY
        echo "| **SMA200** | $SMA200 |" >> $GITHUB_STEP_SUMMARY
        echo "| **QQQ vs SMA200** | $QQQ_VS_SMA |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Trading Thresholds" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Threshold | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **BUY (+5%)** | $BUY_THRESHOLD |" >> $GITHUB_STEP_SUMMARY
        echo "| **SELL (-3%)** | $SELL_THRESHOLD |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Current Signal" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Position:** $POSITION" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** $SIGNAL" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Add alert badge if BUY or SELL
        if [ "$ALERT_TYPE" = "BUY" ]; then
          echo "## ðŸš¨ TRADING ALERT: BUY SIGNAL DETECTED ðŸš¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action Required**: Consider entering TQQQ position" >> $GITHUB_STEP_SUMMARY
        elif [ "$ALERT_TYPE" = "SELL" ]; then
          echo "## ðŸš¨ TRADING ALERT: SELL SIGNAL DETECTED ðŸš¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action Required**: Consider exiting TQQQ position to cash" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ No action required - holding current position" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "_Automated signal generated at $(date -u +"%Y-%m-%d %H:%M:%S UTC")_" >> $GITHUB_STEP_SUMMARY

    - name: Upload signal output
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: daily-signal-${{ github.run_number }}
        path: |
          signal_output.txt
          data/signals_log.csv
        retention-days: 90

    - name: Commit updated cache and chart
      # Only commit if:
      # 1. Workflow succeeded
      # 2. Fresh data was fetched (not cached)
      # 3. This is a scheduled run (not manual trigger)
      if: success() && steps.signal.outputs.should_commit == 'true' && github.event_name == 'schedule'
      run: |
        # Update last_updated.json with current date
        cat > .github/last_updated.json << EOF
        {
          "date": "${{ steps.signal.outputs.trade_date }}",
          "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "status": "success"
        }
        EOF

        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add data/market_data_cache.pkl data/tqqq_sma_chart.html data/position_state.json .github/last_updated.json

        # Only commit if there are changes
        if git diff --staged --quiet; then
          echo "â„¹ï¸  No changes to cache, chart, position, or timestamp"
        else
          git commit -m "chore: update market data, position state [${{ steps.signal.outputs.trade_date }}] [skip ci]"
          git push
          echo "âœ… Updated cache, chart, position state, and timestamp committed"
        fi

    - name: Skip commit message
      if: success() && (steps.signal.outputs.should_commit != 'true' || github.event_name != 'schedule')
      run: |
        echo "â„¹ï¸  Skipping commit because:"
        if [ "${{ steps.signal.outputs.should_commit }}" != "true" ]; then
          echo "   - Using cached data (no fresh fetch)"
        fi
        if [ "${{ github.event_name }}" != "schedule" ]; then
          echo "   - Manual workflow run (only scheduled runs commit)"
        fi
        echo ""
        echo "Summary and artifacts will still be generated."

    - name: Fail workflow on trading signal (to trigger notification)
      if: steps.signal.outputs.is_alert == 'true'
      run: |
        echo "ðŸš¨ Trading signal detected: ${{ steps.signal.outputs.alert_type }}"
        echo "This intentional failure triggers GitHub notification"
        exit 1

    - name: Create Issue on BUY Signal
      if: always() && steps.signal.outputs.alert_type == 'BUY'
      uses: actions/github-script@v7
      with:
        script: |
          const output = `## ðŸŸ¢ BUY SIGNAL DETECTED

          ### Market Data
          - ${{ steps.signal.outputs.date }}
          - ${{ steps.signal.outputs.qqq_close }}
          - ${{ steps.signal.outputs.tqqq_close }}
          - ${{ steps.signal.outputs.sma200 }}
          - ${{ steps.signal.outputs.qqq_vs_sma }}

          ### Thresholds
          - ${{ steps.signal.outputs.buy_threshold }}
          - ${{ steps.signal.outputs.sell_threshold }}

          ### Action Required
          **BUY TQQQ** - QQQ has crossed above the 200-day SMA +5% threshold

          ### Current Position
          ${{ steps.signal.outputs.position }}

          ---
          _This is an automated alert from the TQQQ 200 SMA strategy._
          _Generated: ${new Date().toISOString()}_
          `;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸŸ¢ TQQQ BUY SIGNAL - ' + new Date().toISOString().split('T')[0],
            body: output,
            labels: ['trading-signal', 'buy']
          });

    - name: Create Issue on SELL Signal
      if: always() && steps.signal.outputs.alert_type == 'SELL'
      uses: actions/github-script@v7
      with:
        script: |
          const output = `## ðŸ”´ SELL SIGNAL DETECTED

          ### Market Data
          - ${{ steps.signal.outputs.date }}
          - ${{ steps.signal.outputs.qqq_close }}
          - ${{ steps.signal.outputs.tqqq_close }}
          - ${{ steps.signal.outputs.sma200 }}
          - ${{ steps.signal.outputs.qqq_vs_sma }}

          ### Thresholds
          - ${{ steps.signal.outputs.buy_threshold }}
          - ${{ steps.signal.outputs.sell_threshold }}

          ### Action Required
          **SELL TQQQ** - QQQ has crossed below the 200-day SMA -3% threshold

          ### Current Position
          ${{ steps.signal.outputs.position }}

          ---
          _This is an automated alert from the TQQQ 200 SMA strategy._
          _Generated: ${new Date().toISOString()}_
          `;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸ”´ TQQQ SELL SIGNAL - ' + new Date().toISOString().split('T')[0],
            body: output,
            labels: ['trading-signal', 'sell']
          });

