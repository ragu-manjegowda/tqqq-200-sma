name: Daily TQQQ Signal

on:
  schedule:
    # Run at 9:10 PM UTC (4:10 PM ET) every weekday after market close
    - cron: '10 21 * * 1-5'
  workflow_dispatch:  # Allow manual trigger

# Required permissions for pushing commits
permissions:
  contents: write  # Allow writing to repository
  issues: write    # Allow creating issues on signals

jobs:
  # Job 1: Setup and API Health Check
  api-check:
    name: ðŸŒ API Health Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    - name: Install dependencies
      run: uv sync
    - name: Create data directory
      run: mkdir -p data
    - name: Test Yahoo Finance API
      run: |
        echo "Testing Yahoo Finance API accessibility..."
        uv run python tests/test_yfinance_api.py
    - name: Upload cached data
      uses: actions/upload-artifact@v4
      with:
        name: market-data
        path: data/
        retention-days: 1

  # Job 2: Generate Trading Signal
  generate-signal:
    name: ðŸ“Š Generate Signal
    runs-on: ubuntu-latest
    needs: api-check
    outputs:
      signal: ${{ steps.parse.outputs.signal }}
      date: ${{ steps.parse.outputs.date }}
      qqq_close: ${{ steps.parse.outputs.qqq_close }}
      tqqq_close: ${{ steps.parse.outputs.tqqq_close }}
      sma200: ${{ steps.parse.outputs.sma200 }}
      qqq_vs_sma: ${{ steps.parse.outputs.qqq_vs_sma }}
      buy_threshold: ${{ steps.parse.outputs.buy_threshold }}
      sell_threshold: ${{ steps.parse.outputs.sell_threshold }}
      position: ${{ steps.parse.outputs.position }}
      alert_type: ${{ steps.parse.outputs.alert_type }}
      is_alert: ${{ steps.parse.outputs.is_alert }}
      trade_date: ${{ steps.parse.outputs.trade_date }}
      should_commit: ${{ steps.parse.outputs.should_commit }}
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    - name: Install dependencies
      run: uv sync
    - name: Download cached data
      uses: actions/download-artifact@v4
      with:
        name: market-data
        path: data/
    - name: Run TQQQ signal script
      id: run
      run: |
        uv run tqqq-sma > signal_output.txt 2>&1
        SCRIPT_EXIT_CODE=$?

        echo "Script exited with code: $SCRIPT_EXIT_CODE"
        cat signal_output.txt

        if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
          echo "âŒ Script failed"
          exit 1
        fi

        # Check if fresh data was fetched
        if grep -q "Using cached data" signal_output.txt; then
          echo "should_commit=false" >> $GITHUB_OUTPUT
        else
          echo "should_commit=true" >> $GITHUB_OUTPUT
        fi
    - name: Parse output
      id: parse
      if: success()
      run: |
        SIGNAL=$(grep -E "(ALERT: BUY|ALERT: SELL|STATUS: Holding)" signal_output.txt | tail -1 || echo "No signal detected")
        DATE=$(grep "Date:" signal_output.txt | grep -v "Last Signal" | head -1 | awk '{print $2}' || echo "Unknown")
        QQQ_CLOSE=$(grep "QQQ Close:" signal_output.txt | head -1 | awk '{print $3}' || echo "Unknown")
        TQQQ_CLOSE=$(grep "TQQQ Close:" signal_output.txt | head -1 | awk '{print $3}' || echo "Unknown")
        SMA200=$(grep "SMA200:" signal_output.txt | grep -v "QQQ vs" | head -1 | awk '{print $2}' || echo "Unknown")
        QQQ_VS_SMA=$(grep "QQQ vs SMA200:" signal_output.txt | head -1 | awk '{print $4}' || echo "Unknown")
        BUY_THRESHOLD=$(grep "BUY Threshold" signal_output.txt | head -1 | awk '{print $4}' || echo "Unknown")
        SELL_THRESHOLD=$(grep "SELL Threshold" signal_output.txt | head -1 | awk '{print $4}' || echo "Unknown")
        POSITION=$(grep "Position:" signal_output.txt | head -1 | awk '{print $2}' || echo "Unknown")
        SHOULD_COMMIT=$(echo "${{ steps.run.outputs.should_commit }}")

        echo "=== Captured Data ==="
        echo "SIGNAL: [$SIGNAL]"
        echo "DATE: [$DATE]"
        echo "QQQ_CLOSE: [$QQQ_CLOSE]"
        echo "TQQQ_CLOSE: [$TQQQ_CLOSE]"
        echo "SMA200: [$SMA200]"
        echo "QQQ_VS_SMA: [$QQQ_VS_SMA]"
        echo "BUY_THRESHOLD: [$BUY_THRESHOLD]"
        echo "SELL_THRESHOLD: [$SELL_THRESHOLD]"
        echo "POSITION: [$POSITION]"
        echo "====================="

        {
          echo "signal=$SIGNAL"
          echo "date=$DATE"
          echo "qqq_close=$QQQ_CLOSE"
          echo "tqqq_close=$TQQQ_CLOSE"
          echo "sma200=$SMA200"
          echo "qqq_vs_sma=$QQQ_VS_SMA"
          echo "buy_threshold=$BUY_THRESHOLD"
          echo "sell_threshold=$SELL_THRESHOLD"
          echo "position=$POSITION"
          echo "should_commit=$SHOULD_COMMIT"
        } >> $GITHUB_OUTPUT

        # Determine alert type
        if echo "$SIGNAL" | grep -q "ALERT: BUY"; then
          echo "alert_type=BUY" >> $GITHUB_OUTPUT
          echo "is_alert=true" >> $GITHUB_OUTPUT
        elif echo "$SIGNAL" | grep -q "ALERT: SELL"; then
          echo "alert_type=SELL" >> $GITHUB_OUTPUT
          echo "is_alert=true" >> $GITHUB_OUTPUT
        else
          echo "alert_type=HOLD" >> $GITHUB_OUTPUT
          echo "is_alert=false" >> $GITHUB_OUTPUT
        fi

        TRADE_DATE=$(echo "$DATE")
        echo "trade_date=$TRADE_DATE" >> $GITHUB_OUTPUT
    - name: Upload signal output
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: signal-output
        path: |
          signal_output.txt
          data/
        retention-days: 90

  # Job 3: Generate Summary
  summary:
    name: ðŸ“ Generate Summary
    runs-on: ubuntu-latest
    needs: generate-signal
    if: always()
    steps:
    - name: Generate Summary
      run: |
        DATE='${{ needs.generate-signal.outputs.date }}'
        QQQ_CLOSE='${{ needs.generate-signal.outputs.qqq_close }}'
        TQQQ_CLOSE='${{ needs.generate-signal.outputs.tqqq_close }}'
        SMA200='${{ needs.generate-signal.outputs.sma200 }}'
        QQQ_VS_SMA='${{ needs.generate-signal.outputs.qqq_vs_sma }}'
        BUY_THRESHOLD='${{ needs.generate-signal.outputs.buy_threshold }}'
        SELL_THRESHOLD='${{ needs.generate-signal.outputs.sell_threshold }}'
        POSITION='${{ needs.generate-signal.outputs.position }}'
        SIGNAL='${{ needs.generate-signal.outputs.signal }}'
        ALERT_TYPE='${{ needs.generate-signal.outputs.alert_type }}'

        echo "# ðŸ“Š TQQQ 200-Day SMA Daily Signal" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Market Data" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Date** | $DATE |" >> $GITHUB_STEP_SUMMARY
        echo "| **QQQ Close** | $QQQ_CLOSE |" >> $GITHUB_STEP_SUMMARY
        echo "| **TQQQ Close** | $TQQQ_CLOSE |" >> $GITHUB_STEP_SUMMARY
        echo "| **SMA200** | $SMA200 |" >> $GITHUB_STEP_SUMMARY
        echo "| **QQQ vs SMA200** | $QQQ_VS_SMA |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Trading Thresholds" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Threshold | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **BUY (+5%)** | $BUY_THRESHOLD |" >> $GITHUB_STEP_SUMMARY
        echo "| **SELL (-3%)** | $SELL_THRESHOLD |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Current Signal" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Position:** $POSITION" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** $SIGNAL" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "$ALERT_TYPE" = "BUY" ]; then
          echo "## ðŸš¨ TRADING ALERT: BUY SIGNAL DETECTED ðŸš¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action Required**: Consider entering TQQQ position" >> $GITHUB_STEP_SUMMARY
        elif [ "$ALERT_TYPE" = "SELL" ]; then
          echo "## ðŸš¨ TRADING ALERT: SELL SIGNAL DETECTED ðŸš¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action Required**: Consider exiting TQQQ position to cash" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ No action required - holding current position" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "_Automated signal generated at $(date -u +"%Y-%m-%d %H:%M:%S UTC")_" >> $GITHUB_STEP_SUMMARY

  # Job 4: Commit Updates (only on schedule + fresh data)
  commit-updates:
    name: ðŸ’¾ Commit Updates
    runs-on: ubuntu-latest
    needs: generate-signal
    if: success() && needs.generate-signal.outputs.should_commit == 'true' && github.event_name == 'schedule'
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Download updated data
      uses: actions/download-artifact@v4
      with:
        name: signal-output
        path: .
    - name: Commit and push
      run: |
        cat > .github/last_updated.json << EOF
        {
          "date": "${{ needs.generate-signal.outputs.trade_date }}",
          "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "status": "success"
        }
        EOF

        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add data/market_data_cache.pkl data/tqqq_sma_chart.html data/position_state.json .github/last_updated.json

        if git diff --staged --quiet; then
          echo "â„¹ï¸  No changes to commit"
        else
          git commit -m "chore: update market data, position state [${{ needs.generate-signal.outputs.trade_date }}] [skip ci]"
          git push
          echo "âœ… Updates committed"
        fi

  # Job 5: Create GitHub Issue (only on BUY signal)
  notify-buy:
    name: ðŸŸ¢ BUY Alert
    runs-on: ubuntu-latest
    needs: generate-signal
    if: always() && needs.generate-signal.outputs.alert_type == 'BUY'
    steps:
    - uses: actions/github-script@v7
      with:
        script: |
          const output = `## ðŸŸ¢ BUY SIGNAL DETECTED

          ### Market Data
          - Date: ${{ needs.generate-signal.outputs.date }}
          - QQQ Close: ${{ needs.generate-signal.outputs.qqq_close }}
          - TQQQ Close: ${{ needs.generate-signal.outputs.tqqq_close }}
          - SMA200: ${{ needs.generate-signal.outputs.sma200 }}
          - QQQ vs SMA200: ${{ needs.generate-signal.outputs.qqq_vs_sma }}

          ### Thresholds
          - BUY Threshold: ${{ needs.generate-signal.outputs.buy_threshold }}
          - SELL Threshold: ${{ needs.generate-signal.outputs.sell_threshold }}

          ### Action Required
          **BUY TQQQ** - QQQ has crossed above the 200-day SMA +5% threshold

          ### Current Position
          ${{ needs.generate-signal.outputs.position }}

          ---
          _This is an automated alert from the TQQQ 200 SMA strategy._
          _Generated: ${new Date().toISOString()}_
          `;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸŸ¢ TQQQ BUY SIGNAL - ' + new Date().toISOString().split('T')[0],
            body: output,
            labels: ['trading-signal', 'buy']
          });

  # Job 6: Create GitHub Issue (only on SELL signal)
  notify-sell:
    name: ðŸ”´ SELL Alert
    runs-on: ubuntu-latest
    needs: generate-signal
    if: always() && needs.generate-signal.outputs.alert_type == 'SELL'
    steps:
    - uses: actions/github-script@v7
      with:
        script: |
          const output = `## ðŸ”´ SELL SIGNAL DETECTED

          ### Market Data
          - Date: ${{ needs.generate-signal.outputs.date }}
          - QQQ Close: ${{ needs.generate-signal.outputs.qqq_close }}
          - TQQQ Close: ${{ needs.generate-signal.outputs.tqqq_close }}
          - SMA200: ${{ needs.generate-signal.outputs.sma200 }}
          - QQQ vs SMA200: ${{ needs.generate-signal.outputs.qqq_vs_sma }}

          ### Thresholds
          - BUY Threshold: ${{ needs.generate-signal.outputs.buy_threshold }}
          - SELL Threshold: ${{ needs.generate-signal.outputs.sell_threshold }}

          ### Action Required
          **SELL TQQQ** - QQQ has crossed below the 200-day SMA -3% threshold

          ### Current Position
          ${{ needs.generate-signal.outputs.position }}

          ---
          _This is an automated alert from the TQQQ 200 SMA strategy._
          _Generated: ${new Date().toISOString()}_
          `;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸ”´ TQQQ SELL SIGNAL - ' + new Date().toISOString().split('T')[0],
            body: output,
            labels: ['trading-signal', 'sell']
          });

  # Job 7: Trigger Notification (intentional failure for alerts)
  trigger-notification:
    name: ðŸ”” Trigger Notification
    runs-on: ubuntu-latest
    needs: [generate-signal, notify-buy, notify-sell]
    if: always() && needs.generate-signal.outputs.is_alert == 'true'
    steps:
    - name: Fail to trigger notification
      run: |
        echo "ðŸš¨ Trading signal detected: ${{ needs.generate-signal.outputs.alert_type }}"
        echo "This intentional failure triggers GitHub notification"
        exit 1
